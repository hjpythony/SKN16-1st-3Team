# -*- coding: utf-8 -*-
"""Untitled10.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1N_rozaiNaNhVvJ7QW4axVidISxg1ybz4
"""

!pip install pymysql sqlalchemy

sql_file_path = '/content/project/sql/sql.sql'

with open(sql_file_path, 'r', encoding='utf-8') as f:
    sql_query = f.read()

print(sql_query[:500])

import sqlite3
import pandas as pd

# sqlite ë©”ëª¨ë¦¬ DB ìƒì„±
conn = sqlite3.connect(':memory:')

# sql íŒŒì¼ ì½ê¸°
with open('/content/project/sql/sql.sql', 'r', encoding='utf-8') as f:
    sql_script = f.read()

# sql ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í…Œì´ë¸” ìƒì„± + ë°ì´í„° ì‚½ì…)
conn.executescript(sql_script)

# ì¿¼ë¦¬ ì‹¤í–‰ í›„ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
df = pd.read_sql_query('SELECT * FROM ev', conn)

print(df.head())

from sqlalchemy import create_engine
import pandas as pd

from google.colab import drive
drive.mount('/content/drive')

import pandas as pd

# CSV íŒŒì¼ ê²½ë¡œ
csv_path = '/content/project/csv/registration status.csv'  # ì‹¤ì œ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½í•˜ì„¸ìš”

# CSV ë¶ˆëŸ¬ì˜¤ê¸°, ì¸ì½”ë”©ì´ UTF-8ì´ ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì¸ì½”ë”© ì˜µì…˜ í™•ì¸ í•„ìš”
df = pd.read_csv(csv_path, encoding='utf-8')

# ë°ì´í„° í™•ì¸
print(df.head())

# map_df['ê°’'] = pd.to_numeric(map_df['ê°’'], errors='coerce')
# map_df = map_df.dropna(subset=['ê°’'])

# for f in geo_data['features']:
#     print(f['properties']['name'])  # ì´ ê°’ê³¼ map_df['ì§€ì—­ëª…'] ì´ ì¼ì¹˜í•´ì•¼ í•¨

import pandas as pd

# ì˜ˆì‹œ: ì—‘ì…€ ë˜ëŠ” CSVì—ì„œ ë°”ë¡œ ì½ì–´ì˜¨ í˜•íƒœë¼ê³  ê°€ì •
data = {
    'ì„œìš¸': [88212],
    'ë¶€ì‚°': [48623],
    'ëŒ€êµ¬': [37027],
    'ì¸ì²œ': [62986],
    'ê´‘ì£¼': [16641],
    'ëŒ€ì „': [22843],
    'ìš¸ì‚°': [10786],
    'ì„¸ì¢…': [5934],
    'ê²½ê¸°': [169781],
    'ê°•ì›': [22455],
    'ì¶©ë¶': [28860],
    'ì¶©ë‚¨': [34545],
    'ì „ë¶': [26902],
    'ì „ë‚¨': [35169],
    'ê²½ë¶': [37957],
    'ê²½ë‚¨': [52856],
    'ì œì£¼': [52529]
}

df = pd.DataFrame(data)

# í–‰ 1ê°œì§œë¦¬ wide í˜•íƒœ â†’ long í˜•íƒœë¡œ ë³€í™˜
map_df = df.melt(var_name='ì§€ì—­ëª…', value_name='ê°’')
print(map_df)

ì§€ì—­ëª…_ë§¤í•‘ = {
    'ì„œìš¸': 'ì„œìš¸íŠ¹ë³„ì‹œ',
    'ë¶€ì‚°': 'ë¶€ì‚°ê´‘ì—­ì‹œ',
    'ëŒ€êµ¬': 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
    'ì¸ì²œ': 'ì¸ì²œê´‘ì—­ì‹œ',
    'ê´‘ì£¼': 'ê´‘ì£¼ê´‘ì—­ì‹œ',
    'ëŒ€ì „': 'ëŒ€ì „ê´‘ì—­ì‹œ',
    'ìš¸ì‚°': 'ìš¸ì‚°ê´‘ì—­ì‹œ',
    'ì„¸ì¢…': 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
    'ê²½ê¸°': 'ê²½ê¸°ë„',
    'ê°•ì›': 'ê°•ì›ë„',
    'ì¶©ë¶': 'ì¶©ì²­ë¶ë„',
    'ì¶©ë‚¨': 'ì¶©ì²­ë‚¨ë„',
    'ì „ë¶': 'ì „ë¼ë¶ë„',
    'ì „ë‚¨': 'ì „ë¼ë‚¨ë„',
    'ê²½ë¶': 'ê²½ìƒë¶ë„',
    'ê²½ë‚¨': 'ê²½ìƒë‚¨ë„',
    'ì œì£¼': 'ì œì£¼íŠ¹ë³„ìì¹˜ë„'
}

map_df['ì§€ì—­ëª…'] = map_df['ì§€ì—­ëª…'].map(ì§€ì—­ëª…_ë§¤í•‘)

pip install streamlit streamlit-folium

import streamlit as st
import folium
import json
import pandas as pd
from streamlit_folium import folium_static

# ---------------------------
# ìƒ˜í”Œ ë°ì´í„°í”„ë ˆì„ (map_df) ì˜ˆì‹œ
# ì‹¤ì œë¡œëŠ” CSV ë¶ˆëŸ¬ì˜¤ê¸°ë‚˜ DBì—ì„œ ê°€ì ¸ì™€ë„ ë©ë‹ˆë‹¤
map_df = pd.DataFrame({
    'ì§€ì—­ëª…': ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'],
    'ê°’': [88212, 48623, 37027, 62986, 16641, 22843, 10786, 5934, 169781, 22455, 28860, 34545, 26902, 35169, 37957, 52856, 52529]
})

# ---------------------------
# GeoJSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
with open('/content/project/map/skorea_provinces_geo.json', encoding='utf-8') as f:
    geo_data = json.load(f)

# ê°’ ë”•ì…”ë„ˆë¦¬ ë§Œë“¤ê¸°
value_dict = map_df.set_index('ì§€ì—­ëª…')['ê°’'].to_dict()

# ê° ì§€ì—­ featureì— 'value' í•„ë“œ ì¶”ê°€
for feature in geo_data['features']:
    region_name = feature['properties']['name']
    feature['properties']['value'] = value_dict.get(region_name, 'ê°’ ì—†ìŒ')

# ---------------------------
# ì§€ë„ ìƒì„±
m = folium.Map(location=[36.5, 127.5], zoom_start=7)

# Choropleth
folium.Choropleth(
    geo_data=geo_data,
    data=map_df,
    columns=['ì§€ì—­ëª…', 'ê°’'],
    key_on='feature.properties.name',
    fill_color='YlOrRd',
    fill_opacity=0.7,
    line_opacity=0.2,
    legend_name='ì§€ì—­ë³„ ê°’'
).add_to(m)

# íˆ´íŒ í‘œì‹œìš© íˆ¬ëª… ë ˆì´ì–´
folium.GeoJson(
    geo_data,
    style_function=lambda feature: {
        'fillColor': 'transparent',
        'color': 'transparent',
        'weight': 0,
    },
    tooltip=folium.GeoJsonTooltip(
        fields=['name', 'value'],
        aliases=['', ''],
        localize=True,
        style="""
            font-size: 16px;
            font-weight: bold;
            background-color: white;
            border: 1px solid black;
            border-radius: 3px;
            box-shadow: 3px;
        """
    )
).add_to(m)

# ---------------------------
# Streamlitìœ¼ë¡œ ì¶œë ¥
st.title("ğŸ“ ëŒ€í•œë¯¼êµ­ ì§€ì—­ë³„ ë°ì´í„° ì§€ë„")
folium_static(m)

!pip install streamlit

!wget -q -O - ipv4.icanhazip.com
!streamlit run app.py & npx localtunnel --port 8501



print([f['properties']['name'] for f in geo_data['features']])

import pandas as pd
import folium
import json

# ë°ì´í„° ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ ë° NaN ì²˜ë¦¬
df['ê°’'] = pd.to_numeric(df['ê°’'], errors='coerce')
df = df.dropna(subset=['ê°’'])

# Choropleth ìƒì„±
m = folium.Map(location=[36.5, 127.5], zoom_start=7)

folium.Choropleth(
    geo_data=geo_data,
    data=df,
    columns=['ì§€ì—­ëª…', 'ê°’'],
    key_on='feature.properties.name',
    fill_color='YlGnBu',
    fill_opacity=0.7,
    line_opacity=0.3,
    legend_name='ë°ì´í„° ê°’'
).add_to(m)

m

print(df.dtypes)
print(df['ê°’'].apply(type).value_counts())

df = df.dropna(subset=['ê°’']).copy()

print(df[df['ê°’'].isna()])

print(df['ê°’'].head(10))
print(df['ì§€ì—­ëª…'].head(10))

folium.Choropleth(
    geo_data=geo_data,
    data=df,
    columns=['ì§€ì—­ëª…', 'ê°’'],
    key_on='feature.properties.name',
    fill_color='YlGnBu',
    fill_opacity=0.7,
    line_opacity=0.3,
    legend_name='ë°ì´í„° ê°’'
).add_to(m)

for i, v in enumerate(df['ê°’']):
    if not isinstance(v, (int, float)):
        print(i, v, type(v))

print(df.head())               # ë°ì´í„°í”„ë ˆì„ ì¼ë¶€ ì¶œë ¥
print(df.dtypes)               # ì»¬ëŸ¼ë³„ íƒ€ì… ì¶œë ¥

print(df['ê°’'].apply(type).value_counts())  # 'ê°’' ì»¬ëŸ¼ì— ì–´ë–¤ íƒ€ì…ë“¤ì´ ìˆëŠ”ì§€

# ìˆ«ì ë³€í™˜ ë¶ˆê°€ëŠ¥í•œ ê°’ ì¶œë ¥
for i, v in enumerate(df['ê°’']):
    if not (isinstance(v, (int, float)) and not isinstance(v, bool)):
        print(f"Non-numeric at index {i}: value={v}, type={type(v)}")



